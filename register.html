<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - Federal League</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="register-container">
        <div class="register-form">
            <div class="register-header">
                <img src="images/register-bg.jpg" alt="Federal League" class="register-image" onerror="this.style.display='none'">
                <div class="register-header-overlay">
                    <img src="images/logo.png" alt="Federal League" class="register-logo">
                    <h2>Создание аккаунта</h2>
                    <p>Присоединяйтесь к Federal League</p>
                </div>
            </div>

            <div class="register-form-content">
                <div class="register-message" id="register-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="message-text"></span>
                </div>

                <form id="register-form">
                    <div class="form-group">
                        <label for="register-username">Имя пользователя *</label>
                        <input type="text" id="register-username" name="username" required 
                               placeholder="Придумайте уникальное имя" 
                               minlength="3" maxlength="20">
                        <div class="error-message" id="username-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-email">Email адрес *</label>
                        <input type="email" id="register-email" name="email" required 
                               placeholder="Ваш настоящий email">
                        <div class="error-message" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password">Пароль *</label>
                        <div class="password-input">
                            <input type="password" id="register-password" name="password" required 
                                   placeholder="Не менее 6 символов"
                                   minlength="6">
                            <button type="button" class="toggle-password" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="password-strength-bar"></div>
                        </div>
                        <div class="password-strength-text" id="password-strength-text"></div>
                        
                        <div class="password-requirements">
                            <ul>
                                <li id="req-length" class="invalid">Не менее 6 символов</li>
                                <li id="req-uppercase" class="invalid">Заглавная буква</li>
                                <li id="req-lowercase" class="invalid">Строчная буква</li>
                                <li id="req-number" class="invalid">Цифра</li>
                            </ul>
                        </div>
                        <div class="error-message" id="password-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">Подтверждение пароля *</label>
                        <div class="password-input">
                            <input type="password" id="register-password-confirm" name="password-confirm" required 
                                   placeholder="Повторите ваш пароль">
                            <button type="button" class="toggle-password" id="toggle-password-confirm">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="password-confirm-error"></div>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="agree-terms" name="agree-terms" required>
                        <label for="agree-terms">
                            Я соглашаюсь с 
                            <a href="terms.html" target="_blank">правилами использования</a> 
                            и 
                            <a href="privacy.html" target="_blank">политикой конфиденциальности</a>
                        </label>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="newsletter" name="newsletter">
                        <label for="newsletter">
                            Подписаться на новости и обновления сервера
                        </label>
                    </div>

                    <button type="submit" class="btn-primary" id="register-btn">
                        <i class="fas fa-user-plus"></i>
                        Создать аккаунт
                    </button>
                </form>

                <div class="register-links">
                    <a href="index.html">
                        <i class="fas fa-home"></i>
                        Вернуться на главную
                    </a>
                    <a href="login.html">
                        <i class="fas fa-sign-in-alt"></i>
                        Уже есть аккаунт? Войти
                    </a>
                </div>
            </div>
        </div>
    </div>

<script>
// Функция для показа уведомлений
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 5000);
}

// Функция проверки сложности пароля
function checkPasswordStrength(password) {
    let strength = 0;
    const requirements = {
        length: false,
        uppercase: false,
        lowercase: false,
        number: false
    };

    if (password.length >= 6) {
        strength += 1;
        requirements.length = true;
        document.getElementById('req-length').className = 'valid';
    } else {
        document.getElementById('req-length').className = 'invalid';
    }

    if (/[A-Z]/.test(password)) {
        strength += 1;
        requirements.uppercase = true;
        document.getElementById('req-uppercase').className = 'valid';
    } else {
        document.getElementById('req-uppercase').className = 'invalid';
    }

    if (/[a-z]/.test(password)) {
        strength += 1;
        requirements.lowercase = true;
        document.getElementById('req-lowercase').className = 'valid';
    } else {
        document.getElementById('req-lowercase').className = 'invalid';
    }

    if (/[0-9]/.test(password)) {
        strength += 1;
        requirements.number = true;
        document.getElementById('req-number').className = 'valid';
    } else {
        document.getElementById('req-number').className = 'invalid';
    }

    // Обновляем полосу прогресса
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    const width = (strength / 4) * 100;
    strengthBar.style.width = width + '%';
    
    if (strength === 0) {
        strengthBar.style.background = 'var(--red-color)';
        strengthText.textContent = 'Очень слабый';
        strengthText.style.color = 'var(--red-color)';
    } else if (strength === 1) {
        strengthBar.style.background = 'var(--red-color)';
        strengthText.textContent = 'Слабый';
        strengthText.style.color = 'var(--red-color)';
    } else if (strength === 2) {
        strengthBar.style.background = 'var(--main-color)';
        strengthText.textContent = 'Средний';
        strengthText.style.color = 'var(--main-color)';
    } else if (strength === 3) {
        strengthBar.style.background = 'var(--green-color)';
        strengthText.textContent = 'Сильный';
        strengthText.style.color = 'var(--green-color)';
    } else {
        strengthBar.style.background = 'var(--green-color)';
        strengthText.textContent = 'Очень сильный';
        strengthText.style.color = 'var(--green-color)';
    }

    return requirements;
}

// Функция валидации email
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Функция валидации имени пользователя
function validateUsername(username) {
    const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
    return usernameRegex.test(username);
}

// Функция для определения IP-адреса
async function getIPAddress() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Ошибка получения IP:', error);
        return 'unknown';
    }
}

// Функция проверки существующего пользователя
function isUserExists(username, email) {
    const users = JSON.parse(localStorage.getItem('fl_users') || '[]');
    return users.some(user => 
        user.username.toLowerCase() === username.toLowerCase() || 
        user.email.toLowerCase() === email.toLowerCase()
    );
}

// Функция создания нового пользователя
async function createNewUser(username, email, password, newsletter) {
    const ip = await getIPAddress();
    
    const newUser = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        username: username,
        email: email,
        password: password,
        ip: ip,
        newsletter: newsletter === 'on',
        registrationDate: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
        balance: 100, // Стартовый баланс
        level: 1,
        playtime: '0 ч',
        premium: false,
        role: 'player'
    };
    
    // Сохраняем пользователя
    const users = JSON.parse(localStorage.getItem('fl_users') || '[]');
    users.push(newUser);
    localStorage.setItem('fl_users', JSON.stringify(users));
    
    return newUser;
}

// Обработка формы регистрации
document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const username = formData.get('username');
    const email = formData.get('email');
    const password = formData.get('password');
    const confirmPassword = formData.get('password-confirm');
    const agreeTerms = formData.get('agree-terms');
    const newsletter = formData.get('newsletter');
    
    // Валидация
    if (!validateUsername(username)) {
        showNotification('Имя пользователя должно содержать 3-20 символов (только буквы, цифры и подчеркивания)', 'error');
        return;
    }
    
    if (!validateEmail(email)) {
        showNotification('Введите корректный email адрес', 'error');
        return;
    }
    
    const passwordRequirements = checkPasswordStrength(password);
    if (!passwordRequirements.length) {
        showNotification('Пароль должен содержать минимум 6 символов', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('Пароли не совпадают', 'error');
        return;
    }
    
    if (!agreeTerms) {
        showNotification('Необходимо принять правила использования', 'error');
        return;
    }
    
    // Проверка существующего пользователя
    if (isUserExists(username, email)) {
        showNotification('Пользователь с таким именем или email уже существует', 'error');
        return;
    }
    
    const registerBtn = document.getElementById('register-btn');
    const originalText = registerBtn.innerHTML;
    
    registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
    registerBtn.disabled = true;
    
    try {
        // Создаем нового пользователя
        const newUser = await createNewUser(username, email, password, newsletter);
        
        showNotification('Регистрация успешна! Добро пожаловать в Federal League!', 'success');
        
        // Автоматически входим после регистрации
        localStorage.setItem('currentUser', JSON.stringify(newUser));
        
        // Перенаправляем в личный кабинет через 2 секунды
        setTimeout(() => {
            window.location.href = 'account.html';
        }, 2000);
        
    } catch (error) {
        console.error('Registration error:', error);
        showNotification('Ошибка при создании аккаунта', 'error');
    } finally {
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
    }
});

// Переключение видимости пароля
document.querySelectorAll('.toggle-password').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });
});

// Отслеживание сложности пароля
document.getElementById('register-password').addEventListener('input', function(e) {
    checkPasswordStrength(e.target.value);
});

// Проверка при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем демо-аккаунты (если нужно)
    const users = JSON.parse(localStorage.getItem('fl_users') || '[]');
    
    // Демо-аккаунты для тестирования
    const demoAccounts = [
        {
            id: 'admin_001',
            username: 'admin',
            email: 'admin@federal-league.ru',
            password: 'admin123',
            role: 'administrator',
            balance: 10000,
            level: 50,
            playtime: '350 ч',
            premium: true,
            registrationDate: new Date('2023-01-15').toISOString()
        },
        {
            id: 'demo_001',
            username: 'demo',
            email: 'demo@federal-league.ru',
            password: 'password',
            role: 'player',
            balance: 1500,
            level: 24,
            playtime: '127 ч',
            premium: false,
            registrationDate: new Date('2023-03-20').toISOString()
        }
    ];
    
    // Добавляем демо-аккаунты если их нет
    let updated = false;
    demoAccounts.forEach(demoAccount => {
        if (!users.find(u => u.username === demoAccount.username)) {
            users.push(demoAccount);
            updated = true;
        }
    });
    
    if (updated) {
        localStorage.setItem('fl_users', JSON.stringify(users));
    }
    
    // Если пользователь уже авторизован, перенаправляем в кабинет
    const currentUser = localStorage.getItem('currentUser');
    if (currentUser) {
        window.location.href = 'account.html';
    }
});
</script>
</body>
</html>
