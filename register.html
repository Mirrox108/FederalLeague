<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - Federal League</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Добавляем Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="form-container">
        <div class="form-box">
            <div class="form-header">
                <img src="images/register-bg.jpg" alt="Federal League" class="form-image" onerror="this.style.display='none'">
                <div class="form-header-overlay">
                    <img src="images/logo.png" alt="Federal League" class="form-logo">
                    <h2>Создание аккаунта</h2>
                    <p>Присоединяйтесь к Federal League</p>
                </div>
            </div>

            <div class="form-content">
                <div class="form-message" id="register-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="message-text"></span>
                </div>

                <form id="register-form">
                    <div class="form-group">
                        <label for="register-username">Имя пользователя *</label>
                        <input type="text" id="register-username" name="username" required 
                               placeholder="Придумайте уникальное имя" 
                               minlength="3" maxlength="20">
                        <div class="error-message" id="username-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-email">Email адрес *</label>
                        <input type="email" id="register-email" name="email" required 
                               placeholder="Ваш настоящий email">
                        <div class="error-message" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password">Пароль *</label>
                        <div class="password-input">
                            <input type="password" id="register-password" name="password" required 
                                   placeholder="Не менее 6 символов"
                                   minlength="6">
                            <button type="button" class="toggle-password" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="password-strength-bar"></div>
                        </div>
                        <div class="password-strength-text" id="password-strength-text"></div>
                        
                        <div class="password-requirements">
                            <ul>
                                <li id="req-length" class="invalid">Не менее 6 символов</li>
                                <li id="req-uppercase" class="invalid">Заглавная буква</li>
                                <li id="req-lowercase" class="invalid">Строчная буква</li>
                                <li id="req-number" class="invalid">Цифра</li>
                            </ul>
                        </div>
                        <div class="error-message" id="password-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">Подтверждение пароля *</label>
                        <div class="password-input">
                            <input type="password" id="register-password-confirm" name="password-confirm" required 
                                   placeholder="Повторите ваш пароль">
                            <button type="button" class="toggle-password" id="toggle-password-confirm">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="password-confirm-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agree-terms" name="agree-terms" required>
                            <span>Я соглашаюсь с <a href="terms.html" target="_blank">правилами использования</a> и <a href="privacy.html" target="_blank">политикой конфиденциальности</a></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="newsletter" name="newsletter">
                            <span>Подписаться на новости и обновления сервера</span>
                        </label>
                    </div>

                    <button type="submit" class="btn-primary" id="register-btn">
                        <i class="fas fa-user-plus"></i>
                        Создать аккаунт
                    </button>
                </form>

                <div class="form-links">
                    <a href="index.html">
                        <i class="fas fa-home"></i>
                        Вернуться на главную
                    </a>
                    <a href="login.html">
                        <i class="fas fa-sign-in-alt"></i>
                        Уже есть аккаунт? Войти
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Инициализация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBcPC6rEcNLxXAqcRTEjcWXwXrJ7sj43yQ",
      authDomain: "federalleague-e7452.firebaseapp.com",
      projectId: "federalleague-e7452",
      storageBucket: "federalleague-e7452.firebasestorage.app",
      messagingSenderId: "171537204382",
      appId: "1:171537204382:web:e2bf1a98447d0f039ce78f"
    };

    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Функция для показа уведомлений
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 5000);
    }

    // Функция проверки сложности пароля
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: false,
            uppercase: false,
            lowercase: false,
            number: false
        };

        if (password.length >= 6) {
            strength += 1;
            requirements.length = true;
            document.getElementById('req-length').className = 'valid';
        } else {
            document.getElementById('req-length').className = 'invalid';
        }

        if (/[A-Z]/.test(password)) {
            strength += 1;
            requirements.uppercase = true;
            document.getElementById('req-uppercase').className = 'valid';
        } else {
            document.getElementById('req-uppercase').className = 'invalid';
        }

        if (/[a-z]/.test(password)) {
            strength += 1;
            requirements.lowercase = true;
            document.getElementById('req-lowercase').className = 'valid';
        } else {
            document.getElementById('req-lowercase').className = 'invalid';
        }

        if (/[0-9]/.test(password)) {
            strength += 1;
            requirements.number = true;
            document.getElementById('req-number').className = 'valid';
        } else {
            document.getElementById('req-number').className = 'invalid';
        }

        // Обновляем полосу прогресса
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        const width = (strength / 4) * 100;
        strengthBar.style.width = width + '%';
        
        if (strength === 0) {
            strengthBar.style.background = '#e74c3c';
            strengthText.textContent = 'Очень слабый';
            strengthText.style.color = '#e74c3c';
        } else if (strength === 1) {
            strengthBar.style.background = '#e74c3c';
            strengthText.textContent = 'Слабый';
            strengthText.style.color = '#e74c3c';
        } else if (strength === 2) {
            strengthBar.style.background = '#f39c12';
            strengthText.textContent = 'Средний';
            strengthText.style.color = '#f39c12';
        } else if (strength === 3) {
            strengthBar.style.background = '#27ae60';
            strengthText.textContent = 'Сильный';
            strengthText.style.color = '#27ae60';
        } else {
            strengthBar.style.background = '#27ae60';
            strengthText.textContent = 'Очень сильный';
            strengthText.style.color = '#27ae60';
        }

        return requirements;
    }

    // Функция валидации email
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Функция валидации имени пользователя
    function validateUsername(username) {
        return username.length >= 3 && /^[a-zA-Z0-9_]+$/.test(username);
    }

    // Функция для определения IP-адреса
    async function getIPAddress() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error('Ошибка получения IP:', error);
            return 'unknown';
        }
    }

    // Проверка существования имени пользователя в Firestore
    async function checkUsernameExists(username) {
        try {
            const usersRef = db.collection('users');
            const querySnapshot = await usersRef
                .where('username', '==', username)
                .limit(1)
                .get();
            
            return !querySnapshot.empty;
        } catch (error) {
            console.error('Ошибка проверки имени пользователя:', error);
            return false;
        }
    }

    // Проверка существования email в Firestore
    async function checkEmailExists(email) {
        try {
            const usersRef = db.collection('users');
            const querySnapshot = await usersRef
                .where('email', '==', email)
                .limit(1)
                .get();
            
            return !querySnapshot.empty;
        } catch (error) {
            console.error('Ошибка проверки email:', error);
            return false;
        }
    }

    // Обработка формы регистрации
    document.getElementById('register-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-password-confirm').value;
        const agreeTerms = document.getElementById('agree-terms').checked;
        const newsletter = document.getElementById('newsletter').checked;
        
        // Валидация
        if (!validateUsername(username)) {
            showNotification('Имя пользователя должно содержать минимум 3 символа (только буквы, цифры и подчеркивания)', 'error');
            return;
        }
        
        if (!validateEmail(email)) {
            showNotification('Введите корректный email адрес', 'error');
            return;
        }
        
        const passwordRequirements = checkPasswordStrength(password);
        if (!passwordRequirements.length) {
            showNotification('Пароль должен содержать минимум 6 символов', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showNotification('Пароли не совпадают', 'error');
            return;
        }
        
        if (!agreeTerms) {
            showNotification('Необходимо принять правила использования', 'error');
            return;
        }
        
        const registerBtn = document.getElementById('register-btn');
        const originalText = registerBtn.innerHTML;
        
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
        registerBtn.disabled = true;
        
        try {
            // Проверяем, существует ли имя пользователя
            const usernameExists = await checkUsernameExists(username);
            if (usernameExists) {
                showNotification('Это имя пользователя уже занято', 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
                return;
            }
            
            // Проверяем, существует ли email
            const emailExists = await checkEmailExists(email);
            if (emailExists) {
                showNotification('Этот email уже зарегистрирован', 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
                return;
            }
            
            // Создаем пользователя в Firebase Auth
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Получаем IP-адрес
            const ip = await getIPAddress();
            
            // Сохраняем дополнительные данные в Firestore
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                username: username,
                email: email,
                displayName: username,
                role: 'user',
                playtime: 0,
                level: 1,
                balance: 0,
                friendsCount: 0,
                newsletter: newsletter,
                createdAt: new Date(),
                lastLogin: new Date(),
                lastIP: ip
            });
            
            // Добавляем запись в активность
            await db.collection('users').doc(user.uid).collection('activity').add({
                type: 'registration',
                message: 'Аккаунт успешно создан',
                timestamp: new Date(),
                icon: 'user-plus'
            });
            
            showNotification('Регистрация успешна! Добро пожаловать!', 'success');
            
            // Автоматически входим после регистрации
            setTimeout(() => {
                window.location.href = 'account.html';
            }, 2000);
            
        } catch (error) {
            console.error('Ошибка регистрации:', error);
            
            let errorMessage = 'Ошибка регистрации';
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'Этот email уже зарегистрирован';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Неверный формат email';
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = 'Регистрация временно недоступна';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Пароль слишком слабый';
                    break;
                default:
                    errorMessage = error.message;
            }
            
            showNotification(errorMessage, 'error');
        } finally {
            registerBtn.innerHTML = originalText;
            registerBtn.disabled = false;
        }
    });

    // Переключение видимости пароля
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    });

    // Отслеживание сложности пароля
    document.getElementById('register-password').addEventListener('input', function(e) {
        checkPasswordStrength(e.target.value);
    });

    // Проверка при загрузке страницы, если пользователь уже авторизован
    document.addEventListener('DOMContentLoaded', function() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                window.location.href = 'account.html';
            }
        });
        
        // Показываем сообщение об успешной регистрации, если перешли с флагом
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('registered') === 'true') {
            showNotification('Регистрация завершена успешно!', 'success');
        }
    });

    // Добавляем стили для индикатора сложности пароля
    const style = document.createElement('style');
    style.textContent = `
        .password-strength {
            height: 5px;
            background: #eee;
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 3px;
        }
        
        .password-strength-text {
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .password-requirements {
            margin: 10px 0;
        }
        
        .password-requirements ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .password-requirements li {
            font-size: 12px;
            margin: 3px 0;
            display: flex;
            align-items: center;
        }
        
        .password-requirements li:before {
            content: "•";
            margin-right: 5px;
            font-weight: bold;
        }
        
        .password-requirements li.valid {
            color: #27ae60;
        }
        
        .password-requirements li.invalid {
            color: #e74c3c;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>
