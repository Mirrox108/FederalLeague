<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - Federal League</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="register-container">
        <div class="register-form">
            <div class="register-header">
                <img src="images/register-bg.jpg" alt="Federal League" class="register-image" onerror="this.style.display='none'">
                <div class="register-header-overlay">
                    <img src="images/logo.png" alt="Federal League" class="register-logo">
                    <h2>Создание аккаунта</h2>
                    <p>Присоединяйтесь к Federal League</p>
                </div>
            </div>

            <div class="register-form-content">
                <div class="register-message" id="register-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="message-text"></span>
                </div>

                <form id="register-form">
                    <div class="form-group">
                        <label for="register-username">Имя пользователя *</label>
                        <input type="text" id="register-username" name="username" required 
                               placeholder="Придумайте уникальное имя" 
                               minlength="3" maxlength="20">
                        <div class="error-message" id="username-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-email">Email адрес *</label>
                        <input type="email" id="register-email" name="email" required 
                               placeholder="Ваш настоящий email">
                        <div class="error-message" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password">Пароль *</label>
                        <div class="password-input">
                            <input type="password" id="register-password" name="password" required 
                                   placeholder="Не менее 6 символов"
                                   minlength="6">
                            <button type="button" class="toggle-password" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="password-strength-bar"></div>
                        </div>
                        <div class="password-strength-text" id="password-strength-text"></div>
                        
                        <div class="password-requirements">
                            <ul>
                                <li id="req-length" class="invalid">Не менее 6 символов</li>
                                <li id="req-uppercase" class="invalid">Заглавная буква</li>
                                <li id="req-lowercase" class="invalid">Строчная буква</li>
                                <li id="req-number" class="invalid">Цифра</li>
                            </ul>
                        </div>
                        <div class="error-message" id="password-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">Подтверждение пароля *</label>
                        <div class="password-input">
                            <input type="password" id="register-password-confirm" name="password-confirm" required 
                                   placeholder="Повторите ваш пароль">
                            <button type="button" class="toggle-password" id="toggle-password-confirm">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="error-message" id="password-confirm-error"></div>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="agree-terms" name="agree-terms" required>
                        <label for="agree-terms">
                            Я соглашаюсь с 
                            <a href="terms.html" target="_blank">правилами использования</a> 
                            и 
                            <a href="privacy.html" target="_blank">политикой конфиденциальности</a>
                        </label>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="newsletter" name="newsletter">
                        <label for="newsletter">
                            Подписаться на новости и обновления сервера
                        </label>
                    </div>

                    <button type="submit" class="btn-primary" id="register-btn">
                        <i class="fas fa-user-plus"></i>
                        Создать аккаунт
                    </button>
                </form>

                <div class="register-links">
                    <a href="index.html">
                        <i class="fas fa-home"></i>
                        Вернуться на главную
                    </a>
                    <a href="login.html">
                        <i class="fas fa-sign-in-alt"></i>
                        Уже есть аккаунт? Войти
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcPC6rEcNLxXAqcRTEjcWXwXrJ7sj43yQ",
            authDomain: "federalleague-e7452.firebaseapp.com",
            projectId: "federalleague-e7452",
            storageBucket: "federalleague-e7452.firebasestorage.app",
            messagingSenderId: "171537204382",
            appId: "1:171537204382:web:e2bf1a98447d0f039ce78f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Функция для показа уведомлений
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Функция проверки сложности пароля
        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: false,
                uppercase: false,
                lowercase: false,
                number: false
            };

            if (password.length >= 6) {
                strength += 1;
                requirements.length = true;
                document.getElementById('req-length').className = 'valid';
            } else {
                document.getElementById('req-length').className = 'invalid';
            }

            if (/[A-Z]/.test(password)) {
                strength += 1;
                requirements.uppercase = true;
                document.getElementById('req-uppercase').className = 'valid';
            } else {
                document.getElementById('req-uppercase').className = 'invalid';
            }

            if (/[a-z]/.test(password)) {
                strength += 1;
                requirements.lowercase = true;
                document.getElementById('req-lowercase').className = 'valid';
            } else {
                document.getElementById('req-lowercase').className = 'invalid';
            }

            if (/[0-9]/.test(password)) {
                strength += 1;
                requirements.number = true;
                document.getElementById('req-number').className = 'valid';
            } else {
                document.getElementById('req-number').className = 'invalid';
            }

            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');
            
            const width = (strength / 4) * 100;
            strengthBar.style.width = width + '%';
            
            if (strength === 0) {
                strengthBar.style.background = 'var(--red-color)';
                strengthText.textContent = 'Очень слабый';
                strengthText.style.color = 'var(--red-color)';
            } else if (strength === 1) {
                strengthBar.style.background = 'var(--red-color)';
                strengthText.textContent = 'Слабый';
                strengthText.style.color = 'var(--red-color)';
            } else if (strength === 2) {
                strengthBar.style.background = 'var(--main-color)';
                strengthText.textContent = 'Средний';
                strengthText.style.color = 'var(--main-color)';
            } else if (strength === 3) {
                strengthBar.style.background = 'var(--green-color)';
                strengthText.textContent = 'Сильный';
                strengthText.style.color = 'var(--green-color)';
            } else {
                strengthBar.style.background = 'var(--green-color)';
                strengthText.textContent = 'Очень сильный';
                strengthText.style.color = 'var(--green-color)';
            }

            return requirements;
        }

        // Функция валидации email
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Функция валидации имени пользователя
        function validateUsername(username) {
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            return usernameRegex.test(username);
        }

        // Функция регистрации
        async function registerUser(username, email, password, newsletter) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const userData = {
                    username: username,
                    email: email,
                    balance: 100,
                    level: 1,
                    playtime: '0 ч',
                    premium: false,
                    role: 'player',
                    newsletter: newsletter === 'on',
                    registrationDate: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                await setDoc(doc(db, "users", user.uid), userData);
                
                return {
                    uid: user.uid,
                    ...userData
                };
                
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                throw error;
            }
        }

        // Обработка формы регистрации
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const username = formData.get('username');
            const email = formData.get('email');
            const password = formData.get('password');
            const confirmPassword = formData.get('password-confirm');
            const agreeTerms = formData.get('agree-terms');
            const newsletter = formData.get('newsletter');
            
            if (!validateUsername(username)) {
                showNotification('Имя пользователя должно содержать 3-20 символов (только буквы, цифры и подчеркивания)', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showNotification('Введите корректный email адрес', 'error');
                return;
            }
            
            const passwordRequirements = checkPasswordStrength(password);
            if (!passwordRequirements.length) {
                showNotification('Пароль должен содержать минимум 6 символов', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Пароли не совпадают', 'error');
                return;
            }
            
            if (!agreeTerms) {
                showNotification('Необходимо принять правила использования', 'error');
                return;
            }
            
            const registerBtn = document.getElementById('register-btn');
            const originalText = registerBtn.innerHTML;
            
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
            registerBtn.disabled = true;
            
            try {
                const newUser = await registerUser(username, email, password, newsletter);
                
                showNotification('Регистрация успешна! Добро пожаловать!', 'success');
                
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                
                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    showNotification('Email уже используется', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showNotification('Пароль слишком слабый', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showNotification('Неверный формат email', 'error');
                } else {
                    showNotification('Ошибка регистрации: ' + error.message, 'error');
                }
            } finally {
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        });

        // Переключение видимости пароля
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
        });

        // Отслеживание сложности пароля
        document.getElementById('register-password').addEventListener('input', function(e) {
            checkPasswordStrength(e.target.value);
        });

        // Проверка при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                window.location.href = 'account.html';
            }
        });
    </script>
</body>
</html>
