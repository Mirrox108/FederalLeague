<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки аккаунта - Federal League</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Добавляем Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        /* Основные цвета как в account.html */
        :root {
            --primary-color: #444446ff;
            --secondary-color: #b21f1f;
            --accent-color: #fdbb2d;
            --success-color: #4CAF50;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #444446ff;
            --text-color: #333;
            --text-light: #ffffff;
            --bg-light: #f8f9fa;
            --border-color: #f39c12;
        }

        /* Стили для страницы настроек */
        .settings-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c2c2e 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .settings-header h1 {
            margin: 0;
            font-size: 2.2em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .settings-header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }

        .settings-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 15px;
        }

        .tab-button {
            padding: 12px 20px;
            background: #494949;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--accent-color);
            color: #333;
        }

        .tab-button:hover:not(.active) {
            background: #5a5a5a;
        }

        .settings-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .settings-section {
            background: #494949;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .settings-section h2 {
            color: white;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 12px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #666;
            border-radius: 8px;
            background: #333;
            color: white;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(253, 187, 45, 0.2);
        }

        .form-hint {
            color: #aaa;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .btn-save {
            padding: 12px 25px;
            background: var(--accent-color);
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-save:hover {
            background: #ffc246;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(253, 187, 45, 0.3);
        }

        .btn-cancel {
            padding: 12px 25px;
            background: #666;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .btn-cancel:hover {
            background: #777;
            transform: translateY(-2px);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group label {
            margin: 0;
            color: white;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--accent-color);
            object-fit: cover;
            margin-bottom: 15px;
        }

        .avatar-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .avatar-option:hover, .avatar-option.selected {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .danger-zone {
            border: 2px solid var(--error-color);
            background: rgba(231, 76, 60, 0.1);
        }

        .danger-zone h2 {
            border-bottom-color: var(--error-color);
            color: #ff6b6b;
        }

        .btn-danger {
            padding: 12px 25px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .auth-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-light);
            text-align: center;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }

        .auth-status.authenticated {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4CAF50;
        }

        .auth-status.not-authenticated {
            background: #ffebee;
            color: #c62828;
            border-color: #e74c3c;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--error-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        @media (max-width: 768px) {
            .settings-tabs {
                flex-direction: column;
            }
            
            .avatar-options {
                justify-content: center;
            }
        }

        /* Стили для навбара и футера чтобы соответствовать цветовой гамме */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c2c2e 100%);
            margin-bottom: 20px;
        }

        .navbar .link.active {
            background: rgba(255, 255, 255, 0.2);
            color: var(--accent-color);
        }

        .navbar .link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        #footer {
            background: var(--primary-color);
            color: white;
            margin-top: 40px;
        }

        .server-name-footer {
            color: var(--accent-color);
        }

        .social-links .link:hover {
            background: var(--accent-color);
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="menu-mobile">
            <a href="index.html">
                <div class="logo">
                    <img src="images/logo.png" alt="Server logo" class="logo-img">
                    <h3 class="server-name">Federal League</h3>
                </div>
            </a>
            <div class="hamburger">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>

        <div class="links">
            <a href="index.html" class="link">Главная</a>
            <a href="rules.html" class="link">Правила</a>
            <a href="admin-team.html" class="link">Команда</a>
            <a href="contact.html" class="link">Связь</a>
            <a href="account.html" class="link">Личный кабинет</a>
            <a href="settings.html" class="link active">Настройки</a>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="settings-container">
        <div class="auth-status" id="auth-status">
            Проверка статуса аутентификации...
        </div>

        <div class="settings-header">
            <h1>Настройки аккаунта</h1>
            <p>Управление вашими персональными настройками и предпочтениями</p>
        </div>

        <div class="settings-tabs">
            <button class="tab-button active" data-tab="profile">Профиль</button>
            <button class="tab-button" data-tab="privacy">Приватность</button>
            <button class="tab-button" data-tab="notifications">Уведомления</button>
            <button class="tab-button" data-tab="security">Безопасность</button>
            <button class="tab-button" data-tab="danger">Опасная зона</button>
        </div>

        <div class="settings-content">
            <!-- Вкладка профиля -->
            <div class="settings-section" id="tab-profile">
                <h2>Настройки профиля</h2>
                
                <div class="form-group">
                    <label>Аватар</label>
                    <img src="images/player-avatar.png" alt="Аватар" class="avatar-preview" id="avatar-preview">
                    
                    <div class="avatar-options">
                        <img src="images/avatar1.png" class="avatar-option" data-avatar="avatar1">
                        <img src="images/avatar2.png" class="avatar-option" data-avatar="avatar2">
                        <img src="images/avatar3.png" class="avatar-option" data-avatar="avatar3">
                        <img src="images/avatar4.png" class="avatar-option" data-avatar="avatar4">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="displayName">Имя для отображения</label>
                    <input type="text" id="displayName" class="form-control" placeholder="Введите ваше имя">
                    <p class="form-hint">Это имя будут видеть другие игроки</p>
                </div>
                
                <div class="form-group">
                    <label for="status">Статус</label>
                    <input type="text" id="status" class="form-control" placeholder="Ваш статус в игре">
                    <p class="form-hint">Краткое описание вашего текущего статуса</p>
                </div>
                
                <div class="form-group">
                    <label for="bio">Биография</label>
                    <textarea id="bio" class="form-control" rows="4" placeholder="Расскажите о себе..."></textarea>
                </div>
                
                <button class="btn-save" onclick="saveProfileSettings()">
                    <i class="fas fa-save"></i>
                    Сохранить изменения
                </button>
                <button class="btn-cancel" onclick="window.location.href='account.html'">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>

            <!-- Вкладка приватности -->
            <div class="settings-section" id="tab-privacy" style="display: none;">
                <h2>Настройки приватности</h2>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="privacy-profile" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="privacy-profile">Публичный профиль</label>
                </div>
                <p class="form-hint">Разрешить другим игрокам просматривать ваш профиль</p>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="privacy-status" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="privacy-status">Показывать статус онлайн</label>
                </div>
                <p class="form-hint">Показывать другим игрокам, когда вы онлайн</p>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="privacy-friends">
                        <span class="slider"></span>
                    </label>
                    <label for="privacy-friends">Разрешить запросы в друзья</label>
                </div>
                <p class="form-hint">Разрешить другим игрокам отправлять вам запросы на добавление в друзья</p>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="privacy-messages" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="privacy-messages">Разрешить личные сообщения</label>
                </div>
                <p class="form-hint">Разрешить другим игрокам отправлять вам личные сообщения</p>
                
                <button class="btn-save" onclick="savePrivacySettings()">
                    <i class="fas fa-save"></i>
                    Сохранить настройки
                </button>
                <button class="btn-cancel" onclick="window.location.href='account.html'">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>

            <!-- Вкладка уведомлений -->
            <div class="settings-section" id="tab-notifications" style="display: none;">
                <h2>Настройки уведомлений</h2>
                
                <h3 style="color: var(--accent-color); margin-top: 25px;">Игровые уведомления</h3>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="notify-events" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="notify-events">События на сервере</label>
                </div>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="notify-messages" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="notify-messages">Личные сообщения</label>
                </div>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="notify-friend-requests" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="notify-friend-requests">Запросы в друзья</label>
                </div>
                
                <h3 style="color: var(--accent-color); margin-top: 25px;">Электронная почта</h3>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="email-newsletter" checked>
                        <span class="slider"></span>
                    </label>
                    <label for="email-newsletter">Новости и обновления</label>
                </div>
                
                <div class="checkbox-group">
                    <label class="switch">
                        <input type="checkbox" id="email-promotions">
                        <span class="slider"></span>
                    </label>
                    <label for="email-promotions">Акции и специальные предложения</label>
                </div>
                
                <button class="btn-save" onclick="saveNotificationSettings()">
                    <i class="fas fa-save"></i>
                    Сохранить настройки
                </button>
                <button class="btn-cancel" onclick="window.location.href='account.html'">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>

            <!-- Вкладка безопасности -->
            <div class="settings-section" id="tab-security" style="display: none;">
                <h2>Настройки безопасности</h2>
                
                <div class="form-group">
                    <label for="current-password">Текущий пароль</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Введите текущий пароль">
                </div>
                
                <div class="form-group">
                    <label for="new-password">Новый пароль</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Введите новый пароль">
                    <p class="form-hint">Пароль должен содержать не менее 8 символов</p>
                </div>
                
                <div class="form-group">
                    <label for="confirm-password">Подтвердите новый пароль</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="Повторите новый пароль">
                </div>
                
                <button class="btn-save" onclick="changePassword()">
                    <i class="fas fa-key"></i>
                    Сменить пароль
                </button>
                
                <h3 style="color: var(--accent-color); margin-top: 30px;">Активные сессии</h3>
                <p class="form-hint">Здесь отображаются устройства, на которых выполнен вход в ваш аккаунт</p>
                
                <div id="sessions-list" style="margin-top: 20px;">
                    <div style="padding: 15px; background: #333; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Текущее устройство</strong>
                                <p style="margin: 5px 0; font-size: 0.9em;">Windows • Chrome • Москва, Россия</p>
                                <p style="margin: 0; font-size: 0.8em; color: #aaa;">Активна сейчас</p>
                            </div>
                            <button class="btn-danger" style="padding: 8px 15px;" onclick="logoutOtherSessions()">
                                Завершить другие сессии
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Опасная зона -->
            <div class="settings-section danger-zone" id="tab-danger" style="display: none;">
                <h2>Опасная зона</h2>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #ff6b6b;">Удаление аккаунта</h3>
                    <p>После удаления аккаунта все ваши данные будут безвозвратно удалены. Это действие нельзя отменить.</p>
                    <button class="btn-danger" onclick="showDeleteAccountModal()">
                        <i class="fas fa-trash-alt"></i>
                        Удалить аккаунт
                    </button>
                </div>
                
                <div>
                    <h3 style="color: #ff6b6b;">Экспорт данных</h3>
                    <p>Вы можете запросить экспорт всех ваших данных в формате JSON.</p>
                    <button class="btn-save" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Экспортировать данные
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для удаления аккаунта -->
    <div id="deleteAccountModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: #494949; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; border: 2px solid var(--error-color);">
            <h2 style="color: #ff6b6b; margin-top: 0;">Подтверждение удаления аккаунта</h2>
            <p>Вы уверены, что хотите удалить свой аккаунт? Это действие нельзя отменить. Все ваши данные будут безвозвратно удалены.</p>
            
            <div class="form-group">
                <label for="delete-password">Введите ваш пароль для подтверждения</label>
                <input type="password" id="delete-password" class="form-control" placeholder="Ваш пароль">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-danger" onclick="deleteAccount()">
                    <i class="fas fa-trash-alt"></i>
                    Да, удалить аккаунт
                </button>
                <button class="btn-cancel" onclick="hideDeleteAccountModal()">
                    <i class="fas fa-times"></i>
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer">
        <p class="copyright">&copy; 2025 <span class="server-name-footer">Federal League</span>. Все права завоёванны.</p>
        <div class="social-links">
            <a href="#" class="link tiktok-link"><i class="fa-brands fa-tiktok"></i></a>
            <a href="#" class="link instagram-link"><i class="fa-brands fa-telegram"></i></a>
            <a href="#" class="link discord-link-footer"><i class="fa-brands fa-discord"></i></a>
        </div>
    </footer>

    <script>
    // Инициализация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBcPC6rEcNLxXAqcRTEjcWXwXrJ7sj43yQ",
      authDomain: "federalleague-e7452.firebaseapp.com",
      projectId: "federalleague-e7452",
      storageBucket: "federalleague-e7452.firebasestorage.app",
      messagingSenderId: "171537204382",
      appId: "1:171537204382:web:e2bf1a98447d0f039ce78f"
    };

    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Текущий пользователь
    let currentUser = null;

    // Функция для показа уведомлений
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 5000);
    }

    // Переключение между вкладками
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            // Убираем активный класс у всех кнопок
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Добавляем активный класс текущей кнопке
            this.classList.add('active');
            
            // Скрываем все вкладки
            document.querySelectorAll('.settings-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Показываем выбранную вкладку
            const tabId = this.getAttribute('data-tab');
            document.getElementById(`tab-${tabId}`).style.display = 'block';
        });
    });

    // Выбор аватара
    document.querySelectorAll('.avatar-option').forEach(option => {
        option.addEventListener('click', function() {
            // Убираем выделение у всех аватаров
            document.querySelectorAll('.avatar-option').forEach(avatar => {
                avatar.classList.remove('selected');
            });
            
            // Добавляем выделение выбранному аватару
            this.classList.add('selected');
            
            // Обновляем превью
            document.getElementById('avatar-preview').src = this.src;
        });
    });

    // Загрузка настроек пользователя
    async function loadUserSettings(uid) {
        try {
            const userDoc = await db.collection('users').doc(uid).get();
            
            if (!userDoc.exists) {
                throw new Error('Данные пользователя не найдены');
            }

            const userData = userDoc.data();
            
            // Заполняем форму профиля
            document.getElementById('displayName').value = userData.displayName || '';
            document.getElementById('status').value = userData.status || '';
            document.getElementById('bio').value = userData.bio || '';
            
            // Устанавливаем выбранный аватар
            if (userData.avatar) {
                document.getElementById('avatar-preview').src = userData.avatar;
                
                // Выделяем соответствующий аватар в опциях
                document.querySelectorAll('.avatar-option').forEach(avatar => {
                    if (avatar.getAttribute('data-avatar') === userData.avatarType) {
                        avatar.classList.add('selected');
                    }
                });
            }
            
            // Загружаем настройки приватности
            if (userData.privacy) {
                document.getElementById('privacy-profile').checked = userData.privacy.profilePublic !== false;
                document.getElementById('privacy-status').checked = userData.privacy.showOnlineStatus !== false;
                document.getElementById('privacy-friends').checked = userData.privacy.allowFriendRequests !== false;
                document.getElementById('privacy-messages').checked = userData.privacy.allowMessages !== false;
            }
            
            // Загружаем настройки уведомлений
            if (userData.notifications) {
                document.getElementById('notify-events').checked = userData.notifications.serverEvents !== false;
                document.getElementById('notify-messages').checked = userData.notifications.privateMessages !== false;
                document.getElementById('notify-friend-requests').checked = userData.notifications.friendRequests !== false;
                document.getElementById('email-newsletter').checked = userData.notifications.emailNewsletter !== false;
                document.getElementById('email-promotions').checked = userData.notifications.emailPromotions || false;
            }

        } catch (error) {
            console.error('Ошибка загрузки настроек:', error);
            showNotification('Ошибка загрузки настроек', 'error');
        }
    }

    // Сохранение настроек профиля
    async function saveProfileSettings() {
        try {
            const displayName = document.getElementById('displayName').value;
            const status = document.getElementById('status').value;
            const bio = document.getElementById('bio').value;
            
            // Получаем выбранный аватар
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const avatarType = selectedAvatar ? selectedAvatar.getAttribute('data-avatar') : null;
            const avatarUrl = selectedAvatar ? selectedAvatar.src : null;
            
            // Обновляем данные в Firestore
            await db.collection('users').doc(currentUser.uid).update({
                displayName: displayName,
                status: status,
                bio: bio,
                avatar: avatarUrl,
                avatarType: avatarType,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification('Настройки профиля сохранены', 'success');
            
        } catch (error) {
            console.error('Ошибка сохранения профиля:', error);
            showNotification('Ошибка сохранения настроек профиля', 'error');
        }
    }

    // Сохранение настроек приватности
    async function savePrivacySettings() {
        try {
            const privacySettings = {
                profilePublic: document.getElementById('privacy-profile').checked,
                showOnlineStatus: document.getElementById('privacy-status').checked,
                allowFriendRequests: document.getElementById('privacy-friends').checked,
                allowMessages: document.getElementById('privacy-messages').checked
            };
            
            await db.collection('users').doc(currentUser.uid).update({
                privacy: privacySettings,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification('Настройки приватности сохранены', 'success');
            
        } catch (error) {
            console.error('Ошибка сохранения приватности:', error);
            showNotification('Ошибка сохранения настроек приватности', 'error');
        }
    }

    // Сохранение настроек уведомлений
    async function saveNotificationSettings() {
        try {
            const notificationSettings = {
                serverEvents: document.getElementById('notify-events').checked,
                privateMessages: document.getElementById('notify-messages').checked,
                friendRequests: document.getElementById('notify-friend-requests').checked,
                emailNewsletter: document.getElementById('email-newsletter').checked,
                emailPromotions: document.getElementById('email-promotions').checked
            };
            
            await db.collection('users').doc(currentUser.uid).update({
                notifications: notificationSettings,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification('Настройки уведомлений сохранены', 'success');
            
        } catch (error) {
            console.error('Ошибка сохранения уведомлений:', error);
            showNotification('Ошибка сохранения настроек уведомлений', 'error');
        }
    }

    // Смена пароля
    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showNotification('Заполните все поля', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showNotification('Новые пароли не совпадают', 'error');
            return;
        }
        
        if (newPassword.length < 8) {
            showNotification('Пароль должен содержать не менее 8 символов', 'error');
            return;
        }
        
        try {
            // Реаутентификация пользователя
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                currentPassword
            );
            
            await currentUser.reauthenticateWithCredential(credential);
            
            // Смена пароля
            await currentUser.updatePassword(newPassword);
            
            // Очищаем поля
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            showNotification('Пароль успешно изменен', 'success');
            
        } catch (error) {
            console.error('Ошибка смены пароля:', error);
            
            if (error.code === 'auth/wrong-password') {
                showNotification('Текущий пароль неверен', 'error');
            } else {
                showNotification('Ошибка смены пароля', 'error');
            }
        }
    }

    // Завершение других сессий
    async function logoutOtherSessions() {
        try {
            // Здесь должна быть логика завершения других сессий
            // В реальном приложении это может быть реализовано через Firebase Admin SDK на сервере
            
            showNotification('Все другие сессии завершены', 'success');
        } catch (error) {
            console.error('Ошибка завершения сессий:', error);
            showNotification('Ошибка завершения сессий', 'error');
        }
    }

    // Экспорт данных
    async function exportData() {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (!userDoc.exists) {
                throw new Error('Данные пользователя не найдены');
            }
            
            const userData = userDoc.data();
            
            // Создаем JSON-строку с данными
            const jsonData = JSON.stringify(userData, null, 2);
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `federal-league-data-${currentUser.uid}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Данные успешно экспортированы', 'success');
            
        } catch (error) {
            console.error('Ошибка экспорта данных:', error);
            showNotification('Ошибка экспорта данных', 'error');
        }
    }

    // Показать модальное окно удаления аккаунта
    function showDeleteAccountModal() {
        document.getElementById('deleteAccountModal').style.display = 'flex';
    }

    // Скрыть модальное окно удаления аккаунта
    function hideDeleteAccountModal() {
        document.getElementById('deleteAccountModal').style.display = 'none';
    }

    // Удаление аккаунта
    async function deleteAccount() {
        const password = document.getElementById('delete-password').value;
        
        if (!password) {
            showNotification('Введите пароль для подтверждения', 'error');
            return;
        }
        
        try {
            // Реаутентификация пользователя
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                password
            );
            
            await currentUser.reauthenticateWithCredential(credential);
            
            // Удаление данных пользователя из Firestore
            await db.collection('users').doc(currentUser.uid).delete();
            
            // Удаление аккаунта из Firebase Auth
            await currentUser.delete();
            
            showNotification('Аккаунт успешно удален', 'success');
            
            // Перенаправление на главную страницу
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
        } catch (error) {
            console.error('Ошибка удаления аккаунта:', error);
            
            if (error.code === 'auth/wrong-password') {
                showNotification('Неверный пароль', 'error');
            } else {
                showNotification('Ошибка удаления аккаунта', 'error');
            }
        }
    }

    // Проверка статуса аутентификации
    auth.onAuthStateChanged(async (user) => {
        const authStatus = document.getElementById('auth-status');
        
        if (user) {
            currentUser = user;
            authStatus.textContent = `Вы вошли как: ${user.email}`;
            authStatus.className = 'auth-status authenticated';
            
            // Загружаем настройки пользователя
            await loadUserSettings(user.uid);
        } else {
            authStatus.textContent = 'Вы не авторизованы. Перенаправление на страницу входа...';
            authStatus.className = 'auth-status not-authenticated';
            
            // Перенаправляем на страницу входа
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }
    });
    </script>
</body>
</html>