<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход - Federal League</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- ... остальная HTML разметка без изменений ... -->
    <script>
    // Инициализация Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBcPC6rEcNLxXAqcRTEjcWXwXrJ7sj43yQ",
      authDomain: "federalleague-e7452.firebaseapp.com",
      projectId: "federalleague-e7452",
      storageBucket: "federalleague-e7452.firebasestorage.app",
      messagingSenderId: "171537204382",
      appId: "1:171537204382:web:e2bf1a98447d0f039ce78f"
    };
    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Функция для входа через Firebase Authentication
    async function loginWithEmail(email, password) {
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            return userCredential.user;
        } catch (error) {
            console.error('Ошибка входа:', error);
            throw error;
        }
    }

    // Функция для поиска пользователя по username и получения email
    async function findUserEmail(login) {
        try {
            // Ищем по username
            const usernameQuery = await db.collection('users')
                .where('username', '==', login.toLowerCase())
                .limit(1)
                .get();

            if (!usernameQuery.empty) {
                const userData = usernameQuery.docs[0].data();
                return {
                    email: userData.email,
                    userDoc: usernameQuery.docs[0],
                    userData: userData
                };
            }

            // Если login это email, проверяем существует ли такой пользователь
            const emailQuery = await db.collection('users')
                .where('email', '==', login.toLowerCase())
                .limit(1)
                .get();

            if (!emailQuery.empty) {
                const userData = emailQuery.docs[0].data();
                return {
                    email: userData.email,
                    userDoc: emailQuery.docs[0],
                    userData: userData
                };
            }

            return null;
        } catch (error) {
            console.error('Ошибка поиска пользователя:', error);
            throw new Error('Ошибка поиска пользователя');
        }
    }

    // Обработка формы входа
    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const login = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const remember = document.getElementById('remember-me').checked;
        
        if (!login || !password) {
            showFormMessage('Заполните все поля', 'error');
            return;
        }
        
        hideFormMessage();
        
        const loginBtn = document.getElementById('login-btn');
        const originalText = loginBtn.innerHTML;
        
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';
        loginBtn.disabled = true;
        
        try {
            // Ищем пользователя и получаем его email
            const userResult = await findUserEmail(login);
            
            if (!userResult) {
                showFormMessage('Пользователь не найден', 'error');
                return;
            }
            
            const { email, userDoc, userData } = userResult;
            
            // Проверяем статус аккаунта
            if (userData.status !== 'active') {
                showFormMessage('Аккаунт не активирован или заблокирован', 'error');
                return;
            }
            
            // Пытаемся войти через Firebase Authentication
            try {
                const firebaseUser = await loginWithEmail(email, password);
                
                // Обновляем данные последнего входа в Firestore
                await updateLastLogin(userDoc.id);
                
                // Сохраняем данные пользователя
                const userSession = {
                    id: userDoc.id,
                    uid: firebaseUser.uid,
                    username: userData.username,
                    email: userData.email,
                    displayName: userData.displayName || userData.username,
                    rank: userData.rank || 'player',
                    avatar: userData.avatar || 'images/player-avatar.png',
                    lastLogin: new Date().toISOString(),
                    isValid: true
                };
                
                localStorage.setItem('currentUser', JSON.stringify(userSession));
                
                // Запоминаем пользователя
                if (remember) {
                    localStorage.setItem('remembered_user', login);
                } else {
                    localStorage.removeItem('remembered_user');
                }
                
                showNotification('Вход выполнен успешно!', 'success');
                
                // Перенаправляем в личный кабинет
                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 1000);
                
            } catch (authError) {
                // Обрабатываем ошибки аутентификации
                if (authError.code === 'auth/wrong-password') {
                    showFormMessage('Неверный пароль', 'error');
                } else if (authError.code === 'auth/user-not-found') {
                    showFormMessage('Пользователь не найден', 'error');
                } else {
                    showFormMessage('Ошибка входа: ' + authError.message, 'error');
                }
            }
            
        } catch (error) {
            console.error('Ошибка входа:', error);
            showFormMessage(error.message || 'Ошибка входа. Попробуйте позже.', 'error');
        } finally {
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }
    });

    // Функция для обновления последнего входа
    async function updateLastLogin(userId) {
        try {
            const ip = await getIPAddress();
            await db.collection('users').doc(userId).update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                lastIp: ip,
                loginCount: firebase.firestore.FieldValue.increment(1)
            });
        } catch (error) {
            console.error('Ошибка обновления данных входа:', error);
        }
    }

    // ... остальные функции без изменений ...
    </script>
</body>
</html>
